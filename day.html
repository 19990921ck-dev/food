<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日推薦 - 智慧餐廚</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="LOGIN.css">
</head>
<body>
    <!-- 共用導覽列的容器 -->
    <div id="header-placeholder"></div>

    <!-- 主要內容 -->
    <main class="main-content">
        <h2 id="user-greeting" class="mb-4">正在為您準備專屬菜單...</h2>
        <div id="error-container" class="alert alert-danger" style="display: none;"></div>
        <div id="menu-container">
            <!-- 菜單內容將會動態插入此處 -->
        </div>
    </main>

    <!-- Loading 遮罩 -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Bootstrap JS (如果頁面其他地方需要) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 專案設定檔 (包含 GAS URL) -->
    <script src="config.js"></script>
    <!-- 載入合併後的共用 JS -->
    <script src="app.js"></script>
    <script>
        // --- UTILITY FUNCTIONS ---
        function showLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }

        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.textContent = message;
            errorContainer.style.display = 'block';
            document.getElementById('user-greeting').textContent = '無法載入菜單'; // 更新標題
            document.getElementById('menu-container').style.display = 'none'; // 隱藏菜單區
        }

        // --- API CALL ---
        async function callGasApi(action, payload) {
            showLoading(true);
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action, ...payload })
                });
                if (!response.ok) throw new Error(`伺服器錯誤: ${response.statusText}`);
                const result = await response.json();
                if (result.status === 'success') return result;
                else throw new Error(result.message || '發生未知錯誤');
            } catch (error) {
                console.error('API Call Failed:', error);
                showError(error.message);
                return null;
            } finally {
                showLoading(false); // 確保無論成功或失敗，都關閉載入動畫
            }
        }

        // Helper function to render a list of meal items
        function renderInstructionList(items) {
            if (!items || items.length === 0) {
                return '<li class="list-group-item text-muted">無步驟說明</li>';
            }
            return items.map(item => `<li class="list-group-item">${item}</li>`).join('');
        }

        /**
         * 每日推薦頁面的主要邏輯
         * 確保在 common.js 初始化完成後才執行
         */
        async function initializeDailyPage() {
            // 1. 從 URL 取得使用者 ID
            const urlParams = new URLSearchParams(window.location.search);
            const userIdName = urlParams.get('user');

            if (!userIdName) {
                showError('無法識別使用者身份，請返回登入頁面。');
                showLoading(false);
                return;
            }

            // 2. 呼叫後端 API 取得推薦菜單
            const result = await callGasApi('getDailyRecommendation', { id_name: userIdName });

            if (result) {
                // 3. 將菜單顯示在畫面上
                const recipe = result.data;
                document.getElementById('user-greeting').textContent = `為您推薦的晚餐：${recipe.dishName}`;
                const menuContainer = document.getElementById('menu-container');
                menuContainer.innerHTML = `
                    <div class="mb-4">
                        <h4 class="mb-2"><i class="fa-solid fa-carrot me-2 text-warning"></i>精選食材</h4>
                        <ul class="list-group">
                            ${recipe.ingredients.map(ing => `<li class="list-group-item">${ing.name} - ${ing.quantity}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="mb-4">
                        <h4 class="mb-2"><i class="fa-solid fa-kitchen-set me-2 text-primary"></i>烹飪之旅</h4>
                        <ol class="list-group list-group-numbered">
                            ${renderInstructionList(recipe.instructions)}
                        </ol>
                    </div>
                `;
            } else {
                // 如果 result 為 null (API 呼叫失敗), showError 已經處理了 UI
                // 我們可以在此處添加額外的日誌或處理
                console.log("API 呼叫未成功返回資料，頁面顯示錯誤訊息。");
            }
        }
    </script>
</body>
</html>