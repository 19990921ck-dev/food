<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日推薦 - 今日食光</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts for Zen Maru Gothic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <script>document.write(`<link rel="stylesheet" href="style.css?v=${new Date().getTime()}">`)</script>
</head>
<body>
    <!-- 共用導覽列的容器 -->
    <div id="header-placeholder"></div>

    <!-- 主要內容 -->
    <main class="main-content">
        <h2 id="user-greeting" class="mb-4">正在為您準備專屬菜單...</h2>
        <div id="error-container" class="alert alert-danger" style="display: none;"></div>
        <div id="menu-container">
            <!-- 菜單內容將會動態插入此處 -->
        </div>
    </main>

    <!-- Loading 遮罩 -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Bootstrap JS (如果頁面其他地方需要) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 專案設定檔 (包含 GAS URL) -->
    <script src="config.js"></script>
    <!-- 載入合併後的共用 JS -->
    <script src="app.js"></script>
    <script>
        function showError(message) {
            const errorContainer = document.getElementById('error-container');
            errorContainer.textContent = message;
            errorContainer.style.display = 'block';
            document.getElementById('user-greeting').textContent = '無法載入菜單'; // 更新標題
            document.getElementById('menu-container').style.display = 'none'; // 隱藏菜單區
        }

        // Helper function to render a list of meal items
        function renderInstructionList(items) {
            if (!items || items.length === 0) {
                return '<li class="list-group-item text-muted">無步驟說明</li>';
            }
            return items.map(item => `<li class="list-group-item">${item.replace(/^[\s\d一二三四五六七八九十()（）[\]【】.]*?[.:：、)\s]*/, '')}</li>`).join('');
        }

        /**
         * Page-specific initialization function.
         * This will be called by app.js after the DOM is loaded.
         */
        async function initializePage() {
            // 1. 從 URL 取得使用者 ID
            const urlParams = new URLSearchParams(window.location.search);
            const userIdName = urlParams.get('user');

            if (!userIdName) {
                showError('無法識別使用者身份，請返回登入頁面。');
                window.setTimeout(() => { window.location.href = 'index.html'; }, 3000); // 3秒後自動跳轉
                return;
            }

            // 2. Call the backend API using the global callGasApi function
            const result = await callGasApi('getDailyRecommendation', { id_name: userIdName });

            if (result) {
                // 3. 將菜單顯示在畫面上
                const recipe = result.data;
                document.getElementById('user-greeting').textContent = `為您推薦的晚餐：${recipe.dishName}`;
                const menuContainer = document.getElementById('menu-container');
                menuContainer.innerHTML = `
                    <div class="mb-4">
                        <h4 class="mb-2"><i class="fa-solid fa-carrot me-2 text-warning"></i>精選食材</h4>
                        <ul class="list-group">
                            ${recipe.ingredients.map(ing => `<li class="list-group-item">${ing.name} - ${ing.quantity}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="mb-4">
                        <h4 class="mb-2"><i class="fa-solid fa-kitchen-set me-2 text-primary"></i>烹飪之旅</h4>
                        <ol class="list-group list-group-numbered">
                            ${renderInstructionList(recipe.instructions)}
                        </ol>
                    </div>
                `;
            } else {
                // 如果 result 為 null (API 呼叫失敗), showError 已經處理了 UI
                // 我們可以在此處添加額外的日誌或處理
                console.log("API 呼叫未成功返回資料，頁面顯示錯誤訊息。");
            }
        }
    </script>
</body>
</html>
