<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>今日食光</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Google Fonts for Zen Maru Gothic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- 共用導覽列的容器 -->
    <div id="header-placeholder"></div>

    <!-- 登入/註冊時的置中容器 -->
    <div id="auth-container" class="auth-container">
        <div class="container" style="max-width: 450px;">
            <div class="p-4">
                <!-- 登入頁面 -->
                <div id="login-page" class="page active">
                    <div class="text-center mb-4">
                        <i class="fa-solid fa-utensils fa-3x text-primary"></i>
                        <h2 class="mt-2 mb-0">今日食光</h2>
                        <p class="text-muted">登入您的帳號</p>
                    </div>
                    <div id="login-error" class="alert alert-danger" style="display: none;"></div>
                    <form id="login-form">
                        <div class="input-group mb-3">
                            <span class="input-group-text"><i class="fa-solid fa-user"></i></span>
                            <input type="text" id="login-id-name" class="form-control" name="id_name" placeholder="登入帳號 (ID NAME)" required>
                        </div>
                        <div class="input-group mb-4">
                            <span class="input-group-text"><i class="fa-solid fa-lock"></i></span>
                            <input type="password" id="login-pw" class="form-control" name="pw" placeholder="密碼 (PW)" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 btn-lg">登入</button>
                    </form>
                    <div class="text-center mt-3">
                        <button type="button" id="go-to-register" class="btn btn-link">還沒有帳號？前往註冊</button>
                    </div>
                </div>

                <!-- 註冊頁面 -->
                <div id="register-page" class="page">
                    <div class="text-center mb-4">
                        <i class="fa-solid fa-user-plus fa-3x text-primary"></i>
                        <h2 class="mt-2 mb-0">建立新帳號</h2>
                        <p class="text-muted">只需幾個步驟即可加入</p>
                    </div>
                    <div id="register-error" class="alert alert-danger" style="display: none;"></div>
                    <form id="register-form">
                        <div class="mb-3">
                            <input type="text" id="register-id-name" class="form-control" name="id_name" required maxlength="12" placeholder="登入帳號 (ID NAME)">
                            <div class="form-text input-hint">只能使用英文，區分大小寫，上限12個字。</div>
                        </div>
                        <div class="mb-3">
                            <input type="text" id="register-username" class="form-control" name="username" placeholder="希望系統如何稱呼您 (USERNAME)" required>
                        </div>
                        <div class="mb-3">
                            <input type="password" id="register-pw" class="form-control" name="pw" placeholder="密碼 (PW)" required>
                            <div class="form-text input-hint">長度至少8碼，且必須包含大小寫英文字母及數字。</div>
                        </div>
                        <div class="mb-3">
                            <input type="password" id="register-pw-confirm" class="form-control" placeholder="確認密碼" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 btn-lg">註冊</button>
                    </form>
                    <div class="text-center mt-3">
                        <button type="button" id="go-to-login" class="btn btn-link">已經有帳號了？前往登入</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 登入後的主要內容區域 -->
    <main id="main-content" class="main-content" style="display: none;">
        <!-- 飲食忌口頁面 -->
         <div id="style-page" class="page">
            <p class="text-muted">請選擇您偏好的料理風味：</p>
            <div id="style-error" class="alert alert-danger" style="display: none;"></div>
            <form id="style-form" onsubmit="event.preventDefault(); showPage('allergens-page');">
                <div class="mb-3 d-flex flex-wrap allergens-group">
                    <div class="form-check"><input class="form-check-input" type="checkbox" name="style" value="中式" id="cb-中式"><label class="form-check-label" for="cb-中式"> 中式</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" name="style" value="日式" id="cb-日式"><label class="form-check-label" for="cb-日式"> 日式</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" name="style" value="西式" id="cb-西式"><label class="form-check-label" for="cb-西式"> 西式</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" name="style" value="韓式" id="cb-韓式"><label class="form-check-label" for="cb-韓式"> 韓式</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" name="style" value="東南亞風味" id="cb-東南亞風味"><label class="form-check-label" for="cb-東南亞風味"> 東南亞風味</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" name="style" id="cb-style-all"><label class="form-check-label" for="cb-style-all"> 全選</label></div>
                    <button type="submit" id="style-submit-btn" class="btn btn-primary w-100 mt-3" disabled>下一頁</button>
                </div>
            </form>
        </div>
        <div id="allergens-page" class="page">
            <h2 class="mb-3">設定飲食忌口 (含過敏原)及偏好</h2>
            <p class="text-muted">請選擇您過敏或禁忌的項目：</p>
            <div id="allergens-error" class="alert alert-danger" style="display: none;"></div>
            <form id="allergens-form">
                <div class="mb-3 d-flex flex-wrap allergens-group">
                    <div class="form-check"><input class="form-check-input" type="checkbox" name="allergens" value="花生" id="cb-花生"><label class="form-check-label" for="cb-花生"> 花生</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" name="allergens" value="海鮮" id="cb-海鮮"><label class="form-check-label" for="cb-海鮮"> 海鮮</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" name="allergens" value="乳製品" id="cb-乳製品"><label class="form-check-label" for="cb-乳製品"> 乳製品</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" name="allergens" value="麩質" id="cb-麩質"><label class="form-check-label" for="cb-麩質"> 麩質</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" name="allergens" value="雞蛋" id="cb-雞蛋"><label class="form-check-label" for="cb-雞蛋"> 雞蛋</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" name="allergens" value="堅果" id="cb-堅果"><label class="form-check-label" for="cb-堅果"> 堅果</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" name="allergens" value="芒果" id="cb-芒果"><label class="form-check-label" for="cb-芒果"> 芒果</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" name="allergens" value="牛肉" id="cb-牛肉"><label class="form-check-label" for="cb-牛肉"> 牛肉</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" name="allergens" value="豬肉" id="cb-豬肉"><label class="form-check-label" for="cb-豬肉"> 豬肉</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" name="allergens" value="雞肉" id="cb-雞肉"><label class="form-check-label" for="cb-雞肉"> 雞肉</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" name="allergens" value="無" id="cb-無"><label class="form-check-label" for="cb-無"> 無</label></div>
                    <div class="form-check"><input class="form-check-input" type="checkbox" name="allergens" id="cb-allergens-all"><label class="form-check-label" for="cb-allergens-all"> 全選</label></div>
                    <div class="w-100 mt-3">
                        <input type="text" id="custom-allergens" class="form-control" placeholder="其他忌口項目，請用逗號分隔">
                        <div class="form-text input-hint">例如：香菜, 芹菜, 辣椒</div>
                    </div>
                    <button type="submit" id="allergens-submit-btn" class="btn btn-primary w-100 mt-3" disabled>完成設定</button>
                </div>
            </form>
        </div>
        <!-- 功能選擇介面 -->
        <div id="feature-selection-page" class="page">
            <h2 id="welcome-message" class="text-center"></h2>
            <p class="text-center text-muted mt-n2 mb-4">請選擇您要使用的功能：</p>
            <div class="d-grid gap-3">
                <div class="row g-3">
                    <div class="col-12 col-sm-6">
                        <button id="daily-recommendation-btn" class="btn btn-lg btn-outline-primary w-100 feature-button d-flex align-items-center justify-content-center">
                            <i class="bi bi-calendar2-heart me-2"></i><span>每日推薦</span>
                        </button>
                    </div>
                    <div class="col-12 col-sm-6">
                        <button onclick="window.location.href='Ingredient_upload.html'" class="btn btn-lg btn-outline-primary w-100 feature-button d-flex align-items-center justify-content-center">
                            <i class="bi bi-camera me-2"></i><span>食材上傳</span>
                        </button>
                    </div>
                    <div class="col-12 col-sm-6">
                        <button onclick="window.location.href='identification.html'" class="btn btn-lg btn-outline-primary w-100 feature-button d-flex align-items-center justify-content-center">
                            <i class="bi bi-egg-fried me-2"></i><span>料理辨識</span>
                        </button>
                    </div>
                    <div class="col-12 col-sm-6">
                        <button onclick="window.location.href='options.html'" class="btn btn-lg btn-outline-primary w-100 feature-button d-flex align-items-center justify-content-center">
                            <i class="bi bi-clipboard-heart me-2"></i><span>選項推薦</span>
                        </button>
                    </div>
                    <div class="col-12">
                        <button id="history-btn" class="btn btn-lg btn-outline-secondary w-100 feature-button d-flex align-items-center justify-content-center">
                            <i class="bi bi-bookmark-heart me-2"></i><span>歷史紀錄</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- 歷史紀錄 - 來源選擇頁 -->
        <div id="history-source-selection-page" class="page">
            <h2 class="mb-3">查詢歷史紀錄</h2>
            <p class="text-muted">請選擇您要查詢的紀錄來源：</p>
            <div class="d-grid gap-3">
                <button class="btn btn-outline-primary" onclick="fetchHistory('每日推薦')">每日推薦</button>
                <button class="btn btn-outline-primary" onclick="fetchHistory('食材上傳')">食材上傳</button>
                <button class="btn btn-outline-primary" onclick="fetchHistory('料理辨識')">料理辨識</button>
                <button class="btn btn-outline-primary" onclick="fetchHistory('選項推薦')">選項推薦</button>
                <button class="btn btn-secondary mt-3" onclick="showPage('feature-selection-page')">返回功能選單</button>
            </div>
        </div>
        <!-- 歷史紀錄 - 列表頁 -->
        <div id="history-list-page" class="page">
            <h2 id="history-list-title" class="mb-3"></h2>
            <div id="history-list-container" class="list-group">
                <!-- 歷史紀錄列表將動態插入此處 -->
            </div>
            <button class="btn btn-secondary mt-3" onclick="showPage('history-source-selection-page')">返回來源選擇</button>
        </div>
        <!-- 歷史紀錄 - 詳細內容頁 -->
        <div id="history-detail-page" class="page">
            <h2 id="history-dish-name" class="mb-2"></h2>
            <p id="history-dish-date" class="text-muted small mb-4"></p>
            <div class="mb-4">
                <h4 class="mb-2"><i class="fa-solid fa-carrot me-2 text-warning"></i>精選食材</h4>
                <ul id="history-ingredients-list" class="list-group"></ul>
            </div>
            <div class="mb-4">
                <h4 class="mb-2"><i class="fa-solid fa-kitchen-set me-2 text-primary"></i>烹飪之旅</h4>
                <ol id="history-steps-list" class="list-group list-group-numbered"></ol>
            </div>
            <button class="btn btn-secondary mt-3" onclick="showPage('history-list-page')">返回紀錄列表</button>
        </div>
    </main>

    <!-- Loading 遮罩 -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 專案設定檔 (包含 GAS URL) -->
    <script src="config.js"></script>
    <!-- 載入合併後的共用 JS -->
    <script src="app.js"></script>
    <!-- 頁面主要邏輯 -->
    <script>
        // This function needs to be in the global scope for app.js to find it.
        // --- PAGE NAVIGATION (exposed to global scope for header link) ---
        window.showPage = function(pageId) {
            const mainContent = document.getElementById('main-content');
            const authContainer = document.getElementById('auth-container');
            const headerPlaceholder = document.getElementById('header-placeholder');

            // 【需求修改】: 在新使用者設定偏好與忌口時，隱藏頂部導覽列
            if (['style-page', 'allergens-page'].includes(pageId)) {
                // 透過檢查 allergens 是否已存在於 localStorage 來判斷是否為「新註冊流程」
                const user = JSON.parse(localStorage.getItem('loggedInUser') || '{}');
                if (user && user.allergens === undefined) { // 如果 allergens 欄位不存在，代表是新註冊
                    headerPlaceholder.style.display = 'none';
                } else {
                    headerPlaceholder.style.display = 'block';
                }
            } else {
                headerPlaceholder.style.display = 'block'; // 其他頁面一律顯示
            }

            // 如果是登入後的頁面，顯示 header 和 main content
            if (!['login-page', 'register-page'].includes(pageId)) {
                mainContent.style.display = 'block';
                authContainer.style.display = 'none'; // 隱藏登入區塊
            } else { // 否則顯示登入/註冊區塊
                mainContent.style.display = 'none';
                authContainer.style.display = 'flex'; // 顯示登入區塊
            }

            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }
        function initializePage() {
        // --- DOM ELEMENTS ---
        const pages = document.querySelectorAll('.page');
        const authContainer = document.getElementById('auth-container');
        const mainContent = document.getElementById('main-content');
        const loadingOverlay = document.getElementById('loading-overlay');
        let currentUsername = null; // 用於在註冊後儲存使用者名稱

        function showError(page, message) {
            const errorEl = document.getElementById(`${page}-error`);
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.style.display = 'block';
            }
        }

        /**
         * 頁面初始化函式
         * 檢查 localStorage 中是否有登入資訊，若有則直接顯示功能頁面
         */
        function initializeApp() {
            // 1. 優先處理 URL hash，這允許從其他頁面跳轉到特定設定頁
            const hash = decodeURIComponent(window.location.hash.substring(1));
            if (['allergens-page', 'style-page'].includes(hash) && localStorage.getItem('loggedInUser')) {
                const { idName, displayName } = JSON.parse(localStorage.getItem('loggedInUser'));
                currentUsername = idName; // 確保 currentUsername 已設定
                document.getElementById('welcome-message').textContent = `歡迎, ${displayName}`;
                showPage(hash); // 直接顯示 hash 指定的頁面
                // 清除 hash 避免重新整理時再次觸發
                history.pushState("", document.title, window.location.pathname + window.location.search);
                return; // 處理完畢，結束函式
            }

            // 2. 如果沒有 hash，或使用者未登入，則執行正常登入檢查流程
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser) {
                try {
                    const { idName, displayName } = JSON.parse(loggedInUser);
                    currentUsername = idName;
                    document.getElementById('welcome-message').textContent = `歡迎, ${displayName}`;
                    showPage('feature-selection-page'); // 顯示功能選擇頁
                } catch (e) {
                    console.error("Failed to parse user data from localStorage", e);
                    localStorage.removeItem('loggedInUser'); // 解析失敗則清除
                    showPage('login-page'); // 返回登入頁
                }
            } else {
                showPage('login-page'); // 如果未登入，顯示登入頁
            }
        }

        // --- EVENT LISTENERS ---
        initializeApp();

        document.getElementById('go-to-register').addEventListener('click', () => showPage('register-page'));
        document.getElementById('go-to-login').addEventListener('click', () => showPage('login-page'));

        document.getElementById('register-id-name').addEventListener('blur', async (e) => { // 'blur' means when the user clicks away
            const idName = e.target.value.trim();
            if (idName.length === 0 || !/^[A-Za-z]+$/.test(idName)) {
                return;
            }
            
            // Use the global callGasApi function
            const result = await callGasApi('checkIdName', { id_name: idName }, '正在檢查帳號...');
            if (result && !result.available) {
                showError('register', '此帳號已被註冊');
            }
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const idName = document.getElementById('register-id-name').value;
            const pw = document.getElementById('register-pw').value;
            const pwConfirm = document.getElementById('register-pw-confirm').value;

            if (pw !== pwConfirm) {
                showError('register', '兩次輸入的密碼不一致');
                return;
            }
            const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d]{8,}$/;
            if (!passwordRegex.test(pw)) {
                showError('register', '密碼格式不符 (至少8碼，且包含大小寫英文及數字)');
                return;
            }
            if (!/^[A-Za-z]{1,12}$/.test(idName)) {
                showError('register', '登入帳號格式不符 (僅限英文，最多12字)');
                return;
            }
            const username = document.getElementById('register-username').value;

            const result = await callGasApi('register', { id_name: idName, username: username, pw: pw }, '正在註冊...');
            if (result && result.status === 'success') {
                currentUsername = idName; // 使用 idName 來更新過敏原
                // 將登入資訊存入 localStorage
                localStorage.setItem('loggedInUser', JSON.stringify({
                    idName: idName,
                    displayName: username // 註冊時使用輸入的 username
                    // 此時沒有 allergens 欄位，這將成為判斷新註冊流程的依據
                }));
                updateHeaderUsername(); // 即時更新右上角使用者名稱
                showPage('style-page'); // 註冊後先到料理風味頁
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const idName = document.getElementById('login-id-name').value;
            const pw = document.getElementById('login-pw').value;

            const result = await callGasApi('login', { id_name: idName, pw: pw }, '正在登入...');
            if (result && result.status === 'success') {
                const displayName = result.username || idName;
                currentUsername = idName; // 儲存登入帳號以備後用
                localStorage.setItem('loggedInUser', JSON.stringify({
                    idName: idName,
                    displayName: displayName
                }));
                updateHeaderUsername(); // 即時更新右上角使用者名稱
                initializeApp(); // 登入成功後直接重新初始化，避免頁面重載
            }
        });

        document.getElementById('allergens-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // 1. 收集勾選的飲食忌口
            let selectedAllergens = Array.from(document.querySelectorAll('input[name="allergens"]:checked'))
                                         .map(el => el.value);

            // 2. 收集並處理使用者自行輸入的忌口
            const customAllergensInput = document.getElementById('custom-allergens').value.trim();
            if (customAllergensInput) {
                const customItems = customAllergensInput.split(/[,，\s]+/).filter(item => item); // 用逗號、空白分割，並過濾空字串
                selectedAllergens = selectedAllergens.concat(customItems);
            }
            const allergensStr = selectedAllergens.join(',');

            // 收集料理風味
            const selectedStyles = Array.from(document.querySelectorAll('input[name="style"]:checked'))
                                        .map(el => el.value);
            const styleStr = selectedStyles.join(',');

            if (!currentUsername) {
                showError('allergens', '無法識別使用者身份，請重新註冊。');
                return;
            }

            // 將飲食忌口和料理風味一起送出
            const result = await callGasApi('updateAllergens', { id_name: currentUsername, allergens: allergensStr, style: styleStr }, '正在儲存設定...');
            if (result && result.status === 'success') {
                // 【對應修改】: 設定完成後，將偏好寫入 localStorage，這樣下次就不會再隱藏 header
                const user = JSON.parse(localStorage.getItem('loggedInUser'));
                if (user) {
                    user.allergens = allergensStr;
                    user.style = styleStr;
                    localStorage.setItem('loggedInUser', JSON.stringify(user));
                }

                const loggedInUser = localStorage.getItem('loggedInUser');
                if (loggedInUser) {
                    document.getElementById('welcome-message').textContent = `設定完成，歡迎 ${JSON.parse(loggedInUser).displayName}！`;
                }
                showPage('feature-selection-page');
            }
        });

        // 功能選擇：每日推薦
        document.getElementById('daily-recommendation-btn').addEventListener('click', () => {
            if (currentUsername) {
                // 將使用者帳號透過 URL 參數傳遞到 day.html
                window.location.href = `day.html?user=${encodeURIComponent(currentUsername)}`;
            } else {
                alert('無法識別使用者，請重新登入。');
                location.reload();
            }
        });

        // --- 歷史紀錄相關函式 ---
        let fullHistoryData = []; // 用於暫存從後端獲取的完整歷史資料

        // 1. 監聽歷史紀錄主按鈕
        document.getElementById('history-btn').addEventListener('click', () => {
            showPage('history-source-selection-page');
        });

        // --- 表單互動邏輯 ---
        function setupCheckboxGroup(groupName, noneCheckboxId, allCheckboxId, submitButtonId) {
            const checkboxes = document.querySelectorAll(`input[name="${groupName}"]`);
            const noneCheckbox = document.getElementById(noneCheckboxId);
            const allCheckbox = document.getElementById(allCheckboxId);
            const submitButton = document.getElementById(submitButtonId);
            // 修正：valueCheckboxes 應該只包含有值的選項，排除 '無' 和 '全選'
            const valueCheckboxes = Array.from(checkboxes).filter(cb => cb !== noneCheckbox && cb !== allCheckbox);

            function validate() {
                // 修正：只有當 '無' 或至少一個 '有值' 的選項被勾選時，按鈕才啟用
                const isAnyChecked = valueCheckboxes.some(cb => cb.checked) || (noneCheckbox && noneCheckbox.checked);
                submitButton.disabled = !isAnyChecked;
            }

            // 監聽所有 "有值" 的選項
            valueCheckboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    if (cb.checked) {
                        if (noneCheckbox) noneCheckbox.checked = false;
                    }
                    // 檢查是否所有 "有值" 的選項都被選中，以決定 "全選" 的狀態
                    if (allCheckbox) allCheckbox.checked = valueCheckboxes.every(rcb => rcb.checked);
                    validate();
                });
            });

            // 監聽 "無" 選項
            if (noneCheckbox) {
                noneCheckbox.addEventListener('change', () => {
                    if (noneCheckbox.checked) {
                        valueCheckboxes.forEach(cb => cb.checked = false); // 只取消 "有值" 的選項
                        if (allCheckbox) allCheckbox.checked = false;
                    }
                    validate();
                });
            }

            // 監聽 "全選" 選項
            if (allCheckbox) {
                allCheckbox.addEventListener('change', () => {
                    const isChecked = allCheckbox.checked;
                    valueCheckboxes.forEach(cb => cb.checked = isChecked); // 只勾選 "有值" 的選項
                    if (isChecked && noneCheckbox) {
                        noneCheckbox.checked = false;
                    }
                    validate();
                });
            }

            // 初始驗證
            validate();
        }

        // 設定料理風味表單
        // 注意：料理風味沒有 "無" 選項，所以第二個參數傳入一個不存在的 ID
        setupCheckboxGroup('style', 'cb-style-none-nonexistent', 'cb-style-all', 'style-submit-btn');

        // 設定飲食忌口表單
        setupCheckboxGroup('allergens', 'cb-無', 'cb-allergens-all', 'allergens-submit-btn');
        }

    // 將 showHistoryDetail 移到 initializePage 外部，使其成為全域函式
    function showHistoryDetail(index) {
        // 從全域 window 物件讀取資料
        const item = window.fullHistoryData[index];
        const date = new Date(item.date);
        const formattedDate = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;

        document.getElementById('history-dish-name').textContent = item.recipe.dishName;
        document.getElementById('history-dish-date').textContent = `紀錄日期：${formattedDate}`;
        document.getElementById('history-ingredients-list').innerHTML = item.recipe.ingredients.map(ing => `<li class="list-group-item">${ing.name} - ${ing.quantity}</li>`).join('');
        document.getElementById('history-steps-list').innerHTML = item.recipe.instructions.map(step => `<li class="list-group-item">${step.replace(/^\d+\.\s*/, '')}</li>`).join('');
        // 確保 showPage 也是全域的
        window.showPage('history-detail-page');
    }

    // 將 fetchHistory 移到 initializePage 外部，使其成為全域函式
    async function fetchHistory(source) {
        // 確保 currentUsername 存在
        const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
        if (!loggedInUser || !loggedInUser.idName) {
            alert('無法識別使用者身份，請重新登入。');
            return;
        }
        const currentUsername = loggedInUser.idName;

        const payload = { id_name: currentUsername, source: source };
        const result = await callGasApi('getHistory', payload, `正在查詢${source}紀錄...`);

        if (result && result.data) {
            // 注意：fullHistoryData 需要在全域範圍內可存取
            window.fullHistoryData = result.data;
            const container = document.getElementById('history-list-container');
            document.getElementById('history-list-title').textContent = `${source} - 歷史紀錄`;
            container.innerHTML = '';

            if (window.fullHistoryData.length === 0) {
                container.innerHTML = '<p class="text-muted">沒有找到任何紀錄。</p>';
            } else {
                // 【關鍵修正】: 將渲染列表的邏輯加回來
                window.fullHistoryData.forEach((item, index) => {
                    const date = new Date(item.date);
                    const formattedDate = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'list-group-item list-group-item-action';
                    button.textContent = `${formattedDate}_${item.dishName}`;
                    button.onclick = () => showHistoryDetail(index); // 呼叫全域的 showHistoryDetail
                    container.appendChild(button);
                });
            }
            window.showPage('history-list-page');
        }
    }
    </script>
</body>
</html>
